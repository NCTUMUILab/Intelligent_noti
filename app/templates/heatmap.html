{% extends "bootstrap/base.html" %}

{% block title %}
Heatmap
{% endblock %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.js"></script> -->
<script src="https://rawgit.com/Leaflet/Leaflet.heat/gh-pages/dist/leaflet-heat.js"></script>


{% endblock %}
<!-- <style>
#mapid {
height: 180px;
}
</style> -->

{% block content %}
		<form style="width:500px;" id="gps_form">
			<div class="form-group">
				<label for="place">地點</label>
				<input type="text" class="form-control" name="label" id="label" placeholder="地點(ex.家,公司,學校)">
			</div>
			<input type="text" class="form-control" name="lat" id="lat">
			<input type="text" class="form-control" name="lng" id="lng">
			<div class="btn btn-primary" onclick="sendGpsLabel()">Submit</div>
		</form>
		<form style="width:500px;" id="delete_form">
			<label for="place">Marker Id</label>
			<input type="text" class="form-control" name="markerId" id="d_markerId">
			<label for="place">Label</label>
			<input type="text" class="form-control" name="label" id="d_label">
			<label for="lat">lat</label>
			<input type="text" class="form-control" name="lat" id="d_lat">
			<label for="lng">lng</label>
			<input type="text" class="form-control" name="lng" id="d_lng">
			<div class="btn btn-primary" onclick="deleteGpsLabel()">Submit</div>
		</form>

		<div id="mapid" style="width: 70%; height: 1000px; position: relative; outline: none;"></div>

<script>
var markList = [];
var loc_data = [];
var testData = {};
var data = [];

send();
function send() {
	var person = {
		name: $("#test").val(),
	}
	$.ajax({
		url: '/getLocations',
		type: 'post',
		dataType: 'json',
		success: function (data) {
			for(var i =0;i<data.marks.length;i++){
				//console.log(i);
				//console.log("x: ",data.marks[i][0],"y: ",data.marks[i][1]);
				var this_loc = L.latLng(data.marks[i][1],data.marks[i][0]);
				heat.addLatLng(this_loc);
				//loc_data.push(this_loc);
				console.log(this_loc);
				//markList[i] = L.marker([data.marks[i][1],data.marks[i][0]]).addTo(mymap);
				//markList[i].bindPopup("<form class='form-inline'><input class='form-control form-control-sm' type='text' placeholder='Where is here?'><button type='submit' class='btn btn-primary'>Confirm</button></form>").openPopup();
			}
		},
	});
}

var mymap = L.map('mapid').setView([24.7872632,120.9973644], 13);
//var marker = L.marker([51.5, -0.09]).addTo(mymap);

L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
maxZoom: 18,
attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
'Imagery © <a href="http://mapbox.com">Mapbox</a>',
id: 'mapbox.streets'
}).addTo(mymap);

var heat = L.heatLayer(data, {
            radius: 10,
            blur: 5
        }).addTo(mymap);

	var popup = L.popup();

	function onMapClick(e) {
			$("#lat").val(e.latlng.lat)
			$("#lng").val(e.latlng.lng)
	    popup
	        .setLatLng(e.latlng)
	        .setContent("You clicked the map at " + e.latlng.toString())
	        .openOn(mymap);
	}
	var markers = L.layerGroup();

	function sendGpsLabel(){
		$.ajax({
			url: '/createGpsLabel',
			type: 'post',
			data: $("#gps_form").serialize(),
			success: function (data) {
				getGpsLabel()
			},
		});
	}

	function deleteGpsLabel(){
		$.ajax({
			url: '/deleteGpsLabel',
			type: 'post',
			data: $("#delete_form").serialize(),
			success: function (data) {
				getGpsLabel()
			},
		});
	}

	function getGpsLabel(){

		$.ajax({
			url: '/listGpsLabel',
			type: 'get',
			success: function (data) {
				markers.clearLayers()
				console.log(data)
				for(var i=0; i<data.length; i++){
					var m = L.marker([data[i]['lat'],data[i]['lng']]).bindTooltip(data[i]['label'],{direction: 'top',sticky: 'false'})
					m.raw = data[i];
					m.on('click', function(e){
						var data = e.target.raw;
						$("#d_markerId").val(data['markerId'])
						$("#d_label").val(data['label'])
						$("#d_lat").val(data['lat'])
						$("#d_lng").val(data['lng'])
					})
					markers.addLayer(m);
				}
				mymap.addLayer(markers);
			},
		});
	}
	getGpsLabel()


	mymap.on('click', onMapClick);

</script>

{% endblock %}
