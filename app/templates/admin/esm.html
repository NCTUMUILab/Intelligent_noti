{% from "macros.html" import nav_bar with context %}
{% extends "layout.html" %}

{% block head %}
{{ super() }}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
{% endblock %}

{% block title %}
ESM List
{% endblock %}

{% block content %}
{{ nav_bar() }}

<div class="container">
	<div class="row">
		<div class="col-lg-6">
			<h2>List of Users</h2>
			<div class="table-responsive" id="users">
				<input class="search" placeholder="Search Name" />
				<button class="sort btn-default" data-sort="name">Sort by name</button>
				<button class="sort btn-default" data-sort="id">Sort by id</button>
				
				<table class="table table-striped">
					<thead>
						<th>ID</th>
						<th>User</th>
						<th>ESM</th>
					</thead>
					<tbody class="list">
						{% for user in users %}
						<tr>
							<td class="id">{{ user.id }}</td>
							<td class="name">{{ user.username }}</td>
							<td>
								<button class="search-esm-btn btn btn-primary" id="{{user.id}}">Search</button>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
		<div class="col-lg-6">
			<h2><span id="current-contact-name"></span><br>
				<small>目前已選 <span>0</span>位</small>
			</h2>
			<div class="table-responsive" id="esms">
				<table class="table table-striped">
					<thead>
						<th>Sender</th>
						<th>Times</th>
						<th>Add Contact</th>
					</thead>
					<tbody class="list">
						<tr>
							<td class="esmSender"></td>
							<td class="esmNoneOfTime"></td>
							<td><button class="add-contact-btn btn btn-primary">Add</button></td>
							<td class="esmHide" hidden>a</td>
						</tr>
					</tbody>
				</table>
			</div>
			<button id="addContactsBtn" class="btn btn-success btn-block">Submit</button>
			<form id="addContactsForm" action="esm/addNewContacts" method="POST">
				<input id="addContactsData" type="hidden" name="contacts">
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	var contactListOptions = { valueNames: [ 'name', 'id' ] };
	var contactList = new List('users', contactListOptions);
	
	var esmListOptions = { valueNames: [ 'esmSender', 'esmNoneOfTime', 'esmHide' ] };
	var esmList = new List('esms', esmListOptions);
	
	var addContactBtn = $(".add-contact-btn");
	var searchEsmBtn = $(".search-esm-btn");
	var submitBtn = $("#addContactsBtn");
	
	var addContactsList = [];
	refreshCallbacks();
	
	function refreshCallbacks(){
		addContactBtn = $(".add-contact-btn");
		addContactBtn.click(function(){
			$(this).removeClass("btn-primary");
			$(this).addClass("btn-success disabled");
			$(this).text("chosen");
			
			var name = $(this).closest('tr').find('.esmSender').text();
			addContactsList.push(name);
		});
	};
	
	searchEsmBtn.click(function(){
		var currentContactName = $(this).closest('tr').find('.name').text();
		$("#current-contact-name").text(currentContactName);
		
		esmList.remove('esmHide', 'a');
		$.get("esm/get?uid=" + $(this).attr('id'), function(resultDict, status){
			for (var name in resultDict){
				esmList.add({
					esmSender: name,
					esmNoneOfTime: resultDict[name],
					esmHide: 'a'
				});
			}
			refreshCallbacks();
		});
	});
	
	submitBtn.click(function(){
		$("#addContactsData").val(JSON.stringify(addContactsList));
		$("#addContactsForm").submit();
		
	});

</script>
{% endblock %}